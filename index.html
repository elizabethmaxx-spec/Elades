<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elades VIP</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0e1621; --panel: #17212b; --blue: #5288c1; --text: #ffffff; --msg-me: #2b5278; --msg-them: #182533; --gold: #f39c12; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }
        .app { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--panel); padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #000; z-index: 10; }
        .tabs { display: flex; background: var(--panel); border-bottom: 1px solid #000; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.6; font-size: 13px; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--blue); }
        .screen { flex: 1; display: none; overflow-y: auto; flex-direction: column; }
        .screen.active { display: flex; }
        .profile-card { padding: 20px; text-align: center; }
        .p-avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--blue); margin: 0 auto 15px; border: 3px solid var(--blue); object-fit: cover; cursor: pointer; display: block; }
        #chat-window { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; padding-bottom: 140px; }
        .bubble { max-width: 80%; padding: 10px; border-radius: 15px; font-size: 15px; position: relative; }
        .bubble img { max-width: 100%; border-radius: 10px; display: block; }
        .me { background: var(--msg-me); align-self: flex-end; border-bottom-right-radius: 2px; }
        .them { background: var(--msg-them); align-self: flex-start; border-bottom-left-radius: 2px; }
        .gift-tag { font-size: 12px; color: var(--gold); font-weight: bold; margin-bottom: 4px; display: block; }
        .input-panel { background: var(--panel); padding: 12px 12px 40px; display: flex; gap: 10px; position: fixed; bottom: 0; left: 0; right: 0; border-top: 1px solid #000; }
        input[type="text"], textarea { width: 100%; padding: 12px; border-radius: 15px; border: 1px solid #333; background: var(--bg); color: white; outline: none; box-sizing: border-box; }
        .chat-item { padding: 15px; border-bottom: 1px solid #111; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="app">
    <header>
        <b id="header-title">Elades VIP</b>
        <div id="coin-display" style="color: var(--gold); font-size: 14px; font-weight: bold;">üí∞ 0</div>
    </header>
    <div class="tabs" id="main-tabs">
        <div class="tab active" onclick="switchTab('list')">üí¨ –ß–∞—Ç—ã</div>
        <div class="tab" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫</div>
        <div class="tab" onclick="switchTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <div id="screen-list" class="screen active"><div id="chats-container"></div></div>
    
    <div id="screen-search" class="screen">
        <div style="padding: 20px;">
            <input type="text" id="search-nick" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞...">
            <button onclick="startNewChat()" style="width:100%; margin-top:10px; padding:15px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight: bold;">–ù–∞–π—Ç–∏ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="profile-card">
            <img id="my-p-img" src="https://via.placeholder.com/100" class="p-avatar" onclick="adminClick()">
            <input type="file" id="p-file" hidden onchange="upAvatar(this)">
            <button onclick="document.getElementById('p-file').click()" style="background:none; border:1px solid var(--blue); color:var(--blue); padding:8px 15px; border-radius:8px; margin-bottom:15px; font-size: 12px;">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <h2 id="my-p-nick" style="margin: 0 0 5px 0;"></h2>
            <div style="color:var(--gold); font-size: 20px; margin-bottom:15px;">–ë–∞–ª–∞–Ω—Å: <span id="my-p-coins">0</span> üíé</div>
            <textarea id="my-p-bio" placeholder="–û —Å–µ–±–µ..." onchange="saveBio()" style="height: 80px;"></textarea>
            <p style="font-size: 10px; opacity: 0.4; margin-top: 20px;">v. 2.0 VIP Edition</p>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div style="background: var(--panel); padding: 12px; color: var(--blue); font-weight: bold; border-bottom: 1px solid #000;" onclick="switchTab('list')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</div>
        <div id="chat-window"></div>
        <div class="input-panel">
            <div onclick="openGifts()" style="cursor:pointer; font-size:22px;">üéÅ</div>
            <label style="cursor:pointer; font-size:22px;">üñºÔ∏è<input type="file" hidden onchange="uploadImg(this)"></label>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div onclick="sendMsg()" style="cursor:pointer; font-size:22px;">üöÄ</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB8Pbrxvhd867uPB2PvhLKZ4LL-3IDBlac",
        authDomain: "message-b6f96.firebaseapp.com",
        databaseURL: "https://message-b6f96-default-rtdb.firebaseio.com",
        projectId: "message-b6f96",
        storageBucket: "message-b6f96.firebasestorage.app",
        messagingSenderId: "612390801353",
        appId: "1:612390801353:web:28b2e3269942dba13f2218"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myNick = localStorage.getItem('el_user_nick') || prompt("–¢–≤–æ–π –Ω–∏–∫:");
    if(myNick) localStorage.setItem('el_user_nick', myNick.trim());
    myNick = localStorage.getItem('el_user_nick');

    let isAdmin = false;
    let clickCount = 0;
    let myCoins = 0;

    function adminClick() {
        if(myNick === '–°–ò–ú–ê') {
            clickCount++;
            if(clickCount >= 5) {
                isAdmin = true;
                alert("–†–ï–ñ–ò–ú –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù üïµÔ∏è‚Äç‚ôÄÔ∏è");
                loadChatList();
            }
        }
    }

    function switchTab(s) {
        document.querySelectorAll('.screen').forEach(scr => scr.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const targetScreen = document.getElementById('screen-' + s);
        if(targetScreen) targetScreen.classList.add('active');
        
        document.getElementById('main-tabs').style.display = (s === 'chat') ? 'none' : 'flex';
        if(s === 'profile') loadProfile();
        if(s === 'list') loadChatList();
    }

    function loadProfile() {
        document.getElementById('my-p-nick').innerText = "@" + myNick;
        db.ref('users/' + myNick).on('value', snap => {
            const d = snap.val() || {};
            if(d.avatar) document.getElementById('my-p-img').src = d.avatar;
            if(d.bio) document.getElementById('my-p-bio').value = d.bio;
            myCoins = d.coins || 0;
            document.getElementById('my-p-coins').innerText = myCoins;
            document.getElementById('coin-display').innerText = "üí∞ " + myCoins;
        });
    }

    function openGifts() {
        const gift = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫:\n1. –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç (50 üíé)\n2. –ú–µ–¥–≤–µ–∂–æ–Ω–æ–∫ (20 üíé)\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:");
        if(gift === "1" && myCoins >= 50) sendGift("üíé –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç", 50);
        else if(gift === "2" && myCoins >= 20) sendGift("üß∏ –ú–µ–¥–≤–µ–∂–æ–Ω–æ–∫", 20);
        else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!");
    }

    function sendGift(name, price) {
        const id = [myNick, currentChat].sort().join('_');
        db.ref('chats/' + id).push({ u: myNick, t: name, isGift: true });
        db.ref('users/' + myNick + '/coins').set(myCoins - price);
    }

    function upAvatar(el) {
        const r = new FileReader();
        r.onload = e => db.ref('users/' + myNick + '/avatar').set(e.target.result);
        r.readAsDataURL(el.files[0]);
    }

    function saveBio() {
        db.ref('users/' + myNick + '/bio').set(document.getElementById('my-p-bio').value);
    }

    let currentChat = null;
    function openChat(t) {
        currentChat = t;
        switchTab('chat');
        const id = [myNick, t].sort().join('_');
        db.ref('chats/' + id).off();
        db.ref('chats/' + id).on('value', snap => {
            const win = document.getElementById('chat-window');
            win.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const cls = m.u === myNick ? 'me' : 'them';
                const giftHtml = m.isGift ? `<span class="gift-tag">üéÅ –ü–û–î–ê–†–û–ö</span>` : '';
                win.innerHTML += `<div class="bubble ${cls}">${giftHtml}<b>${m.u}:</b><br>${m.t||''}${m.img?`<img src="${m.img}">`:''}</div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function loadChatList() {
        const cont = document.getElementById('chats-container');
        cont.innerHTML = "";
        if(isAdmin && myNick === '–°–ò–ú–ê') {
            db.ref('chats').on('value', snap => {
                cont.innerHTML = "<h3 style='padding:15px; color:var(--gold); margin:0;'>üì° –í—Å–µ —á–∞—Ç—ã —Å–∏—Å—Ç–µ–º—ã:</h3>";
                snap.forEach(chat => {
                    const id = chat.key;
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.style.background = "#1a2430";
                    item.style.margin = "5px 10px";
                    item.style.borderRadius = "10px";
                    item.innerHTML = `üåê ${id.replace('_', ' ‚Üî ')}`;
                    item.onclick = () => { 
                        const parts = id.split('_');
                        openChat(parts[0] === myNick ? parts[1] : parts[0]); 
                    };
                    cont.appendChild(item);
                });
            });
        } else {
            db.ref('contacts/' + myNick).on('value', snap => {
                cont.innerHTML = "";
                snap.forEach(c => {
                    const n = c.key;
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.innerHTML = `<div style="width:40px; height:40px; border-radius:50%; background:var(--blue); display:flex; align-items:center; justify-content:center; font-weight:bold;">${n[0].toUpperCase()}</div><b>@${n}</b>`;
                    item.onclick = () => openChat(n);
                    cont.appendChild(item);
                });
            });
        }
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value || !currentChat) return;
        const id = [myNick, currentChat].sort().join('_');
        db.ref('chats/' + id).push({ u: myNick, t: i.value });
        i.value = "";
        db.ref('users/' + myNick + '/coins').transaction(c => (c || 0) + 1);
    }

    function uploadImg(el) {
        const r = new FileReader();
        r.onload = e => {
            const id = [myNick, currentChat].sort().join('_');
            db.ref('chats/' + id).push({ u: myNick, img: e.target.result });
        };
        r.readAsDataURL(el.files[0]);
    }

    function startNewChat() {
        const t = document.getElementById('search-nick').value.trim().toLowerCase();
        if(t && t !== myNick) {
            db.ref('contacts/'+myNick+'/'+t).set(true);
            db.ref('contacts/'+t+'/'+myNick).set(true);
            openChat(t);
        }
    }
    loadProfile();
    loadChatList();
</script>
</body>
</html>
