<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elades Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0e1621; --panel: #17212b; --blue: #5288c1; --text: #ffffff; --msg-me: #2b5278; --msg-them: #182533; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }
        
        .app { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--panel); padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #000; z-index: 10; }
        
        .tabs { display: flex; background: var(--panel); border-bottom: 1px solid #000; z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.6; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--blue); }

        .screen { flex: 1; display: none; overflow-y: auto; flex-direction: column; position: relative; }
        .screen.active { display: flex; }

        .chat-item { padding: 15px; border-bottom: 1px solid #101921; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        #chat-window { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: cover; padding-bottom: 100px; }
        .bubble { max-width: 80%; padding: 10px; border-radius: 15px; font-size: 15px; position: relative; word-wrap: break-word; }
        .bubble img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .me { background: var(--msg-me); align-self: flex-end; border-bottom-right-radius: 2px; }
        .them { background: var(--msg-them); align-self: flex-start; border-bottom-left-radius: 2px; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê */
        .input-panel { 
            background: var(--panel); 
            padding: 12px 12px 35px 12px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            display: flex; 
            gap: 12px; 
            align-items: center; 
            border-top: 1px solid #000;
            position: fixed; /* –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏, —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–∞ */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        input[type="text"] { 
            flex: 1; 
            padding: 12px; 
            border-radius: 22px; 
            border: 1px solid #333; 
            background: var(--bg); 
            color: white; 
            outline: none; 
            font-size: 16px; /* 16px –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iPhone */
        }
        
        .icon-btn { cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="app">
    <header>
        <b id="header-title">Elades Pro</b>
        <span id="user-tag" style="color: var(--blue); font-size: 12px; font-weight: bold;"></span>
    </header>

    <div class="tabs" id="main-tabs">
        <div class="tab active" onclick="switchTab('list')">üí¨ –ß–∞—Ç—ã</div>
        <div class="tab" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫</div>
    </div>

    <div id="screen-list" class="screen active">
        <div id="chats-container"></div>
    </div>

    <div id="screen-search" class="screen">
        <div style="padding: 20px;">
            <input type="text" id="search-nick" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –¥—Ä—É–≥–∞...">
            <button class="tab active" style="width: 100%; border-radius: 12px; border:none; padding: 15px; font-weight: bold;" onclick="startNewChat()">–ù–∞–π—Ç–∏ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div style="background: var(--panel); padding: 12px; font-size: 14px; border-bottom: 1px solid #000; color: var(--blue); font-weight: bold;" onclick="switchTab('list')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —á–∞—Ç–∞–º</div>
        <div id="chat-window"></div>
        
        <div class="input-panel">
            <label class="icon-btn">üñºÔ∏è<input type="file" id="file-input" accept="image/*" onchange="uploadImg()"></label>
            <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." autocomplete="off">
            <div class="icon-btn" onclick="sendMsg()">üöÄ</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB8Pbrxvhd867uPB2PvhLKZ4LL-3IDBlac",
        authDomain: "message-b6f96.firebaseapp.com",
        databaseURL: "https://message-b6f96-default-rtdb.firebaseio.com",
        projectId: "message-b6f96",
        storageBucket: "message-b6f96.firebasestorage.app",
        messagingSenderId: "612390801353",
        appId: "1:612390801353:web:28b2e3269942dba13f2218"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –Ω–∏–∫ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å
    let myNick = localStorage.getItem('el_user_nick');
    if(!myNick) {
        myNick = prompt("–ü—Ä–∏–¥—É–º–∞–π —Å–≤–æ–π –Ω–∏–∫:");
        if(myNick) localStorage.setItem('el_user_nick', myNick.toLowerCase().trim());
        else location.reload();
    }
    document.getElementById('user-tag').innerText = "@" + myNick;

    let currentChatWith = null;

    function switchTab(screen) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('screen-' + screen).classList.add('active');
        document.getElementById('main-tabs').style.display = (screen === 'chat') ? 'none' : 'flex';
        if(screen === 'list') loadChatList();
    }

    function startNewChat() {
        const target = document.getElementById('search-nick').value.trim().toLowerCase();
        if(!target || target === myNick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –¥—Ä—É–≥–∞!");
        openChat(target);
    }

    function openChat(target) {
        currentChatWith = target;
        document.getElementById('header-title').innerText = "@" + target;
        switchTab('chat');
        
        const chatId = [myNick, target].sort().join('_');
        db.ref('chats/' + chatId).off(); // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        db.ref('chats/' + chatId).on('value', snap => {
            const win = document.getElementById('chat-window');
            win.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = 'bubble ' + (m.u === myNick ? 'me' : 'them');
                if(m.t) div.innerText = m.t;
                if(m.img) div.innerHTML += `<img src="${m.img}">`;
                win.appendChild(div);
            });
            win.scrollTop = win.scrollHeight;
        });
        db.ref('contacts/' + myNick + '/' + target).set(true);
        db.ref('contacts/' + target + '/' + myNick).set(true);
    }

    function loadChatList() {
        db.ref('contacts/' + myNick).on('value', snap => {
            const cont = document.getElementById('chats-container');
            cont.innerHTML = "";
            if(!snap.exists()) {
                cont.innerHTML = `<div style="text-align: center; margin-top: 50px; opacity: 0.5;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤<br>–ù–∞–π–¥–∏—Ç–µ –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ –ü–æ–∏—Å–∫</div>`;
                return;
            }
            snap.forEach(c => {
                const name = c.key;
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.innerHTML = `<div class="avatar">${name[0].toUpperCase()}</div><b>@${name}</b>`;
                item.onclick = () => openChat(name);
                cont.appendChild(item);
            });
        });
    }

    function sendMsg() {
        const i = document.getElementById('msg-input');
        if(!i.value || !currentChatWith) return;
        const chatId = [myNick, currentChatWith].sort().join('_');
        db.ref('chats/' + chatId).push({ u: myNick, t: i.value, time: Date.now() });
        i.value = "";
    }

    function uploadImg() {
        const file = document.getElementById('file-input').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const chatId = [myNick, currentChatWith].sort().join('_');
            db.ref('chats/' + chatId).push({ u: myNick, img: e.target.result, time: Date.now() });
        };
        reader.readAsDataURL(file);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
    document.getElementById('msg-input').onkeypress = function(e) {
        if(e.key === 'Enter') sendMsg();
    };

    loadChatList();
</script>
</body>
</html>
