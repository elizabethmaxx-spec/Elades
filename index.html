<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elades VIP Final Fix</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0e1621; --panel: #17212b; --blue: #5288c1; --text: #ffffff; --msg-me: #2b5278; --msg-them: #182533; --gold: #f39c12; --red: #e74c3c; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }
        .app { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--panel); padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #000; z-index: 100; }
        .tabs { display: flex; background: var(--panel); border-bottom: 1px solid #000; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.6; font-size: 13px; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--blue); }
        .screen { flex: 1; display: none; overflow-y: auto; padding-bottom: 80px; }
        .screen.active { display: flex; flex-direction: column; }
        
        #chat-window { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #0e1621; overflow-y: auto; padding-bottom: 100px; }
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 15px; color: white; position: relative; word-wrap: break-word; }
        .me { background: var(--msg-me); align-self: flex-end; border-bottom-right-radius: 4px; }
        .them { background: var(--msg-them); align-self: flex-start; border-bottom-left-radius: 4px; }
        .system { background: rgba(243, 156, 18, 0.15); border: 1px solid var(--gold); align-self: center; text-align: center; border-radius: 10px; font-size: 12px; width: 90%; color: var(--gold); padding: 5px; }
        .bubble img { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        
        .input-panel { background: var(--panel); padding: 10px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #000; position: fixed; bottom: 0; width: 100%; box-sizing: border-box; z-index: 100; }
        input[type="text"] { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #333; background: var(--bg); color: white; outline: none; }
        
        .chat-item { padding: 15px; border-bottom: 1px solid #1c2835; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .admin-panel { background: #1a2430; margin: 15px; padding: 15px; border-radius: 12px; border: 1px solid var(--gold); display: none; }
        .admin-btn { background: var(--gold); color: black; border: none; padding: 10px; border-radius: 5px; font-weight: bold; margin: 5px; cursor: pointer; width: calc(50% - 15px); font-size: 11px; }

        #ban-screen { display:none; position:fixed; inset:0; background:black; color:white; z-index:10000; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; }
    </style>
</head>
<body>

<div id="ban-screen">
    <h1 style="color:var(--red); font-size: 50px; margin:0;">üö´</h1>
    <h2>–î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</h2>
    <p id="ban-timer" style="color:var(--gold); font-size: 22px; font-weight: bold;"></p>
    <p style="opacity:0.5;">–í—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏, –∫–æ–≥–¥–∞ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ—Ç.</p>
</div>

<div class="app" id="main-app">
    <header>
        <b id="header-title">Elades VIP</b>
        <div id="coin-display" style="color: var(--gold); font-size: 14px; font-weight: bold;">üí∞ 0</div>
    </header>
    
    <div class="tabs" id="main-tabs">
        <div class="tab active" onclick="switchTab('list')">üí¨ –ß–∞—Ç—ã</div>
        <div class="tab" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫</div>
        <div class="tab" onclick="switchTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <div id="screen-list" class="screen active"><div id="chats-container"></div></div>
    
    <div id="screen-search" class="screen">
        <div style="padding: 20px;">
            <input type="text" id="search-nick" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞...">
            <button onclick="startNewChat()" style="width:100%; margin-top:10px; padding:15px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight: bold;">–ù–∞–π—Ç–∏ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="profile-card" style="text-align:center; padding:20px;">
            <div id="my-p-img" onclick="adminClick()" style="width:80px; height:80px; background:var(--blue); border-radius:50%; margin: 0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:30px; cursor:pointer;">üë§</div>
            <h2 id="my-p-nick"></h2>
            <div style="color:var(--gold); font-size: 20px; margin-bottom:15px;">–ë–∞–ª–∞–Ω—Å: <span id="my-p-coins">0</span> üíé</div>
            
            <div id="admin-tools" class="admin-panel">
                <h4 style="margin:0 0 10px 0; color:var(--gold);">üõ† –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–ú–´</h4>
                <button class="admin-btn" onclick="adminGlobalAlert()">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</button>
                <button class="admin-btn" onclick="adminGiveCoins()">üíé –î–∞—Ç—å –º–æ–Ω–µ—Ç—ã</button>
                <button class="admin-btn" style="background:var(--red); color:white;" onclick="adminBanUser()">üö´ –ë–∞–Ω —é–∑–µ—Ä–∞</button>
                <button class="admin-btn" style="background:var(--red); color:white;" onclick="adminClearChat()">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
            </div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <div style="background: var(--panel); padding: 12px; color: var(--blue); font-weight: bold; border-bottom: 1px solid #000;" onclick="switchTab('list')">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</div>
        <div id="chat-window"></div>
        <div class="input-panel">
            <div onclick="openGifts()" style="cursor:pointer; font-size:22px;">üéÅ</div>
            <label style="cursor:pointer; font-size:22px;">üñºÔ∏è<input type="file" hidden onchange="uploadImg(this)"></label>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div onclick="sendMsg()" style="cursor:pointer; font-size:22px;">üöÄ</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB8Pbrxvhd867uPB2PvhLKZ4LL-3IDBlac",
        authDomain: "message-b6f96.firebaseapp.com",
        databaseURL: "https://message-b6f96-default-rtdb.firebaseio.com",
        projectId: "message-b6f96",
        storageBucket: "message-b6f96.firebasestorage.app",
        messagingSenderId: "612390801353",
        appId: "1:612390801353:web:28b2e3269942dba13f2218"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myNick = (localStorage.getItem('el_user_nick') || prompt("–¢–≤–æ–π –Ω–∏–∫:") || "–≥–æ—Å—Ç—å").trim().toLowerCase();
    localStorage.setItem('el_user_nick', myNick);

    let isAdmin = false;
    let clickCount = 0;
    let myCoins = 0;
    let currentChat = null;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–ê–ù–ê
    function checkBan() {
        db.ref('bans/' + myNick).on('value', snap => {
            const until = snap.val();
            if(until) {
                if(until > Date.now()) {
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('ban-screen').style.display = 'flex';
                    
                    const updateTimer = () => {
                        const left = Math.ceil((until - Date.now()) / 1000);
                        if(left <= 0) {
                            db.ref('bans/' + myNick).remove(); // –ß–∏—Å—Ç–∏–º –±–∞–∑—É
                            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –≤—Ö–æ–¥–∞
                        } else {
                            document.getElementById('ban-timer').innerText = `–û—Å—Ç–∞–ª–æ—Å—å: ${Math.floor(left/60)}–º ${left%60}—Å`;
                        }
                    };
                    updateTimer();
                    const itv = setInterval(updateTimer, 1000);
                } else {
                    db.ref('bans/' + myNick).remove(); // –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –≤—ã—à–ª–æ
                }
            }
        });
    }
    checkBan();

    function adminClick() {
        if(myNick === '—Å–∏–º–∞') {
            clickCount++;
            if(clickCount >= 5) {
                isAdmin = true;
                document.getElementById('admin-tools').style.display = 'block';
                document.getElementById('header-title').innerText = "Elades (ADMIN)";
                alert("–°–ò–ú–ê, –î–û–°–¢–£–ü –ü–û–õ–£–ß–ï–ù! üëë");
            }
        }
    }

    function switchTab(s) {
        document.querySelectorAll('.screen').forEach(scr => scr.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('screen-' + s).classList.add('active');
        document.getElementById('main-tabs').style.display = (s === 'chat') ? 'none' : 'flex';
        if(s === 'profile') loadProfile();
        if(s === 'list') loadChatList();
    }

    function loadProfile() {
        document.getElementById('my-p-nick').innerText = "@" + myNick;
        db.ref('users/' + myNick).on('value', snap => {
            const d = snap.val() || {};
            myCoins = d.coins || 0;
            document.getElementById('my-p-coins').innerText = myCoins;
            document.getElementById('coin-display').innerText = "üí∞ " + myCoins;
        });
    }

    // –õ–û–ì–ò–ö–ê –ü–û–î–ê–†–ö–û–í
    function openGifts() {
        const choice = prompt("–ß—Ç–æ –ø–æ–¥–∞—Ä–∏–º?\n1. –†–æ–∑–∞ (10 üíé)\n2. –ê–ª–º–∞–∑ (100 üíé)\n3. –ö–æ—Ä–æ–Ω–∞ (500 üíé)");
        if(choice === "1" && myCoins >= 10) sendGift("üåπ –†–æ–∑–∞", 10);
        else if(choice === "2" && myCoins >= 100) sendGift("üíé –ê–ª–º–∞–∑", 100);
        else if(choice === "3" && myCoins >= 500) sendGift("üëë –ö–æ—Ä–æ–Ω–∞", 500);
        else if(choice) alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!");
    }

    function sendGift(name, price) {
        if(!currentChat) return;
        const id = (isAdmin && currentChat.includes('_')) ? currentChat : [myNick, currentChat].sort().join('_');
        db.ref('chats/' + id).push({ u: myNick, t: name, isGift: true });
        db.ref('users/' + myNick + '/coins').set(myCoins - price);
    }

    function openChat(t) {
        currentChat = t;
        switchTab('chat');
        const id = (isAdmin && t.includes('_')) ? t : [myNick, t].sort().join('_');
        db.ref('chats/' + id).off();
        db.ref('chats/' + id).on('value', snap => {
            const win = document.getElementById('chat-window');
            win.innerHTML = "";
            snap.forEach(c => {
                const m = c.val();
                let cls = (m.u === myNick) ? 'me' : (m.u === 'SYSTEM' ? 'system' : 'them');
                win.innerHTML += `
                    <div class="bubble ${cls}">
                        ${m.isGift ? '<b style="color:var(--gold);">üéÅ –ü–û–î–ê–†–û–ö</b><br>' : ''}
                        <b style="font-size:11px; opacity:0.7;">${m.u}</b><br>
                        ${m.t ? `<span>${m.t}</span>` : ''}
                        ${m.img ? `<img src="${m.img}" style="width:100%;">` : ''}
                    </div>`;
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function loadChatList() {
        const cont = document.getElementById('chats-container');
        const path = isAdmin ? 'chats' : 'contacts/' + myNick;
        db.ref(path).on('value', snap => {
            cont.innerHTML = isAdmin ? "<h3 style='padding:15px; color:var(--gold);'>üåê –ê–î–ú–ò–ù-–û–ë–ó–û–†</h3>" : "";
            snap.forEach(c => {
                const name = c.key;
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.innerHTML = `<b>${isAdmin ? name.replace('_', ' ‚Üî ') : '@'+name}</b>`;
                item.onclick = () => openChat(name);
                cont.appendChild(item);
            });
        });
    }

    function sendMsg() {
        const inp = document.getElementById('msg-input');
        if(!inp.value.trim() || !currentChat) return;
        const id = (isAdmin && currentChat.includes('_')) ? currentChat : [myNick, currentChat].sort().join('_');
        db.ref('chats/' + id).push({ u: myNick, t: inp.value.trim() });
        inp.value = "";
        db.ref('users/' + myNick + '/coins').transaction(c => (c || 0) + 1);
    }

    function uploadImg(el) {
        if(!el.files[0] || !currentChat) return;
        const reader = new FileReader();
        reader.onload = e => {
            const id = (isAdmin && currentChat.includes('_')) ? currentChat : [myNick, currentChat].sort().join('_');
            db.ref('chats/' + id).push({ u: myNick, img: e.target.result });
        };
        reader.readAsDataURL(el.files[0]);
    }

    function adminBanUser() {
        const user = prompt("–ö–æ–≥–æ –±–∞–Ω–∏–º?").toLowerCase().trim();
        if(user === '—Å–∏–º–∞') return alert("–°–∏–º—É –Ω–µ–ª—å–∑—è!");
        const min = parseInt(prompt("–ú–∏–Ω—É—Ç:", "5"));
        if(user && min) db.ref('bans/' + user).set(Date.now() + (min * 60000));
    }

    function adminGlobalAlert() {
        const msg = prompt("–í—Å–µ–º:");
        if(msg) db.ref('chats').once('value', snap => {
            snap.forEach(chat => db.ref('chats/' + chat.key).push({ u: "SYSTEM", t: "üì¢ " + msg }));
        });
    }

    function adminGiveCoins() {
        const user = prompt("–ö–æ–º—É:");
        const amt = parseInt(prompt("–°–∫–æ–ª—å–∫–æ:"));
        if(user && amt) db.ref('users/' + user.toLowerCase() + '/coins').transaction(c => (c || 0) + amt);
    }

    function adminClearChat() {
        if(currentChat && confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
            const id = currentChat.includes('_') ? currentChat : [myNick, currentChat].sort().join('_');
            db.ref('chats/' + id).remove();
        }
    }

    function startNewChat() {
        const t = document.getElementById('search-nick').value.trim().toLowerCase();
        if(t && t !== myNick) {
            db.ref('contacts/'+myNick+'/'+t).set(true);
            db.ref('contacts/'+t+'/'+myNick).set(true);
            openChat(t);
        }
    }

    loadProfile();
    loadChatList();
</script>
</body>
</html>
